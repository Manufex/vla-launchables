services:
  pi05:
    build:
      context: .
      dockerfile: Dockerfile

    network_mode: "host"
    runtime: nvidia

    environment:
      ENV: ${ENV:-brev}

      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility

      HF_HUB_ENABLE_HF_TRANSFER: "1"
      TOKENIZERS_PARALLELISM: "false"

      # Defaults (override in your shell when needed)
      DATASET_REPO_ID: ${DATASET_REPO_ID:-Zasha01/cube_transfer_final}
      OUTPUT_DIR: ${OUTPUT_DIR:-/workspace/outputs/pi05}
      JOB_NAME: ${JOB_NAME:-pi05_cube_transfer_final}
      STEPS: ${STEPS:-3000}
      BATCH_SIZE: ${BATCH_SIZE:-8}

      # W&B (WANDB_API_KEY is passed at runtime by train.sh)
      WANDB_PROJECT: ${WANDB_PROJECT:-vla-train-lab}
      WANDB_SILENT: "true"

    volumes:
      - ../:/workspace

      # Cache volumes (inspired by isaac-style caching)
      - hf-cache:/root/.cache/huggingface
      - torch-cache:/root/.cache/torch
      - pip-cache:/root/.cache/pip
      - wandb-cache:/root/.local/share/wandb

    working_dir: /workspace
    shm_size: "16gb"
    stdin_open: true
    tty: true

volumes:
  hf-cache:
  torch-cache:
  pip-cache:
  wandb-cache:

